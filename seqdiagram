@https://www.websequencediagrams.com

title Automatic Parking Fee Collection w/t Stellar

opt enter
Car->Camera: license plate
Camera->entry-BLE: license plate img
entry-BLE -> openALPR : get camera.$license
openALPR -> entry-BLE : camera.$license

entry-BLE -> App: challenge + $BLEAccID
App -> entry-BLE: response + BLE.tx.mD(App.$appAccID, App.$license)

entry-BLE -> entry-BLE:compare(camera.$license,App.$license)

entry-BLE -> Stellar : sign(BLE.tx.mD(App.$appAccID, App.$license)
Stellar -> entry-BLE : $txEnterMDID
Stellar -> App : $txEnterMDID

entry-BLE -> entry-Gate: open gate command
end



opt exit
Car->Camera: license plate
Camera->exit-BLE: license plate img
exit-BLE -> openALPR : get camera.$license
openALPR -> exit-BLE : camera.$license

exit-BLE -> App: challenge + $BLEAccID
App -> App : compare(Enter.$BLEAccID, Exit.$BLEAccID)
App -> exit-BLE:  response + $txEnterMDID + BLE.tx.mD(App.$appAccID, empty)

exit-BLE -> Stellar :  get $sourceID, mD(App.$appAccID), mD(App.$license) , $EnterTimestamp where App.$txEnterMDID
Stellar -> exit-BLE : $sourceID, mD(App.$appAccID), mD(App.$license), $EnterTimestamp

exit-BLE -> exit-BLE : compare($sourceID, $BLEAccID)
exit-BLE -> exit-BLE: compare(mD(App.$license), camera.$license)\ncompare(mD(App.$appAccID), App.$appAccID)

exit-BLE -> Stellar : sign(BLE.tx.mD(App.$appAccID, empty))
Stellar -> exit-BLE : $txExitMDID

exit-BLE -> Stellar : get $ExitTimeStamp where $txExitMDID
Stellar -> exit-BLE : $EnterTimestamp, $ExitTimeStamp

exit-BLE -> exit-BLE : calculate $amount

exit-BLE -> App: $BLEAccID + $amount

App -> App : compare(new.$BLEAccID, exist.$BLEAccID)
App -> exit-BLE: sign(BLE&App.tx.memo(App.@).payment($BLEAccID, $amount))

exit-BLE -> exit-BLE : compare(payment($BLEAccID), exist.$BLEAccID)\ncompare(payment($amount),exist.$amount)
exit-BLE -> Stellar : sign(signed(Dest&App.tx.payment($BLEAccID, $amount)))
Stellar -> exit-BLE : $txPaymentID

exit-BLE -> exit-Gate: open gate command
end 
